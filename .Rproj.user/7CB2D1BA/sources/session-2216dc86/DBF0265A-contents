eg_ntime <- tibble::tribble(
  ~EGTPT, ~NTIME,
      NA,     NA,
      "PREDOSE",      0,
      "1H POST-DOSE",      1,
      "2H POST-DOSE",      2,
      "3H POST-DOSE",      3,
      "4H POST-DOSE",      4
)

nif <- eg_nif_from_sdtm(sdtm.001, "M1774", eg_ntime=eg_ntime)


in_range <- function(val, ref, window_low, window_high) {
  val >= ref - window_low & val < ref + window_high
}

test <- tibble::tribble(
  ~SUBJ, ~NTIME, ~TIME, ~ANALYTE, ~DV,
      1,     0,   0,      "A",   0,
      1,     0,   0.1,    "B",   1,
      1,     0,   0.2,    "C",   2,
      1,     1,   1,      "A",   3,
      1,     1,   1.1,    "B",   4,
      1,     1,   1.2,    "C",   5
)

test %>% 
  group_by(SUBJ, NTIME) %>%
  mutate(time_A = as.numeric(filter(pick(ANALYTE, DV), ANALYTE == "A")$DV)) %>% 
  ungroup()
           
  

pc_ntl <- tibble::tribble(
  ~PCTPT, ~NTIME,
  "PRE-DOSE",      0,
  "0.5H POST-DOSE",    0.5,
  "1H POST-DOSE",      1,
  "2H POST-DOSE",      2,
  "3H POST-DOSE",      3,
  "4H POST-DOSE",      4,
  "6H POST-DOSE",      6,
  "8H POST-DOSE",      8,
  "END OF INFUSION",     NA,
  "END OF STUDY INTERVENTION",     NA,
  "SAFETY FOLLOW-UP",     NA,
  "24H POST-DOSE",     24
)

nif <- nif::new_nif() %>%
  nif::add_administration(sdtm, extrt, silent = silent) %>%
  nif::add_observation(sdtm, "pc", pctestcd, cmt = 2,
                       include_day_in_ntime = T,
                       duplicates = "resolve",
                       silent = silent) %>% 
  nif::add_observation(sdtm, "eg", "QTCF", cmt = 5,
                       # include_day_in_ntime = TRUE,
                       # NTIME_lookup = eg_ntl,
                       include_day_in_ntime = T,
                       duplicates = "resolve",
                       silent = silent)

nif %>%
  filter(ANALYTE == "M1774") %>%
  filter(EVID == 0) %>% 
  ggplot(aes(x = TAFD, y = NTIME, group = USUBJID, color = ANALYTE)) +
  geom_point() +
  theme_bw()
